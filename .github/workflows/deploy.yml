name: AI Lactate Advisor – CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run basic import tests
        run: |
          python - << 'EOF'
          import streamlit
          import pandas
          import numpy
          import plotly
          import joblib
          print("Python environment OK")
          EOF

      - name: Validate model_utils
        run: |
          python - << 'EOF'
          from model_utils import prepare_features
          import pandas as pd
          df = pd.DataFrame({"hr":[150,152], "power":[200,210]})
          X = prepare_features(df)
          print("prepare_features OK:", X.shape)
          EOF

  docker-build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t ai-lactate-advisor:latest .

  streamlit-sync:
    name: Streamlit Deployment Sync
    runs-on: ubuntu-latest
    needs: docker-build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Sync repo to Streamlit (if token available)
        env:
          STREAMLIT_TOKEN: ${{ secrets.STREAMLIT_TOKEN }}
        run: |
          if [ -z "$STREAMLIT_TOKEN" ]; then
            echo "⚠️ STREAMLIT_TOKEN not set — skipping Streamlit Sync.";
            exit 0;
          fi
          echo "Streamlit Cloud will automatically redeploy on push."
